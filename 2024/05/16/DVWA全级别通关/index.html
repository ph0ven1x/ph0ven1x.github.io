<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta http-equiv="X-UA-COMPATIBLE" content="IE=edge,chrome=1"><meta name="renderer" content="webkit"><link rel="icon" type="image/ico" sizes="32x32" href="/assets/favicon.ico"><link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png"><link rel="alternate" href="/rss.xml" title="日拱一卒 功不唐捐" type="application/rss+xml"><link rel="alternate" href="/atom.xml" title="日拱一卒 功不唐捐" type="application/atom+xml"><link rel="alternate" type="application/json" title="日拱一卒 功不唐捐" href="https://ph0ven1x.github.io/feed.json"><link rel="preconnect" href="https://lf9-cdn-tos.bytecdntp.com"><link rel="preconnect" href="https://at.alicdn.com"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Mulish:400,400italic,700,700italic%7CFredericka%20the%20Great:400,400italic,700,700italic%7CNoto%20Serif%20JP:400,400italic,700,700italic%7CNoto%20Serif%20SC:400,400italic,700,700italic%7CInconsolata:400,400italic,700,700italic&display=swap&subset=latin,latin-ext" media="none" onload="this.media&#x3D;&#39;all&#39;"><link rel="stylesheet" href="/css/app.css?v=0.4.2"><link rel="modulepreload" href="/js/chunk-35ELGMRU.js"><link rel="modulepreload" href="/js/chunk-52NF4PVE.js"><link rel="modulepreload" href="/js/chunk-MDK4KVSQ.js"><link rel="modulepreload" href="/js/chunk-XWLQ2736.js"><link rel="modulepreload" href="/js/index.esm-YD6Q2FEL.js"><link rel="modulepreload" href="/js/post-WGMRFXOO.js"><link rel="modulepreload" href="/js/quicklink-24QY5EII.js"><link rel="modulepreload" href="/js/search-6BFXGXPD.js"><link rel="modulepreload" href="/js/siteInit.js"><link rel="preload" href="/" as="image" fetchpriority="high"><link rel="preload" href="2" as="image" fetchpriority="high"><link rel="preload" href="0" as="image" fetchpriority="high"><link rel="preload" href="2" as="image" fetchpriority="high"><link rel="preload" href="4" as="image" fetchpriority="high"><link rel="preload" href="/" as="image" fetchpriority="high"><link rel="preload" href="0" as="image" fetchpriority="high"><link rel="preload" href="5" as="image" fetchpriority="high"><link rel="preload" href="/" as="image" fetchpriority="high"><link rel="preload" href="1" as="image" fetchpriority="high"><link rel="preload" href="6" as="image" fetchpriority="high"><link rel="preload" href="/" as="image" fetchpriority="high"><link rel="preload" href="D" as="image" fetchpriority="high"><link rel="preload" href="V" as="image" fetchpriority="high"><link rel="preload" href="W" as="image" fetchpriority="high"><link rel="preload" href="A" as="image" fetchpriority="high"><link rel="preload" href="%" as="image" fetchpriority="high"><link rel="preload" href="E" as="image" fetchpriority="high"><link rel="preload" href="5" as="image" fetchpriority="high"><link rel="preload" href="%" as="image" fetchpriority="high"><link rel="preload" href="8" as="image" fetchpriority="high"><link rel="preload" href="5" as="image" fetchpriority="high"><link rel="preload" href="%" as="image" fetchpriority="high"><link rel="preload" href="A" as="image" fetchpriority="high"><link rel="preload" href="8" as="image" fetchpriority="high"><link rel="preload" href="%" as="image" fetchpriority="high"><link rel="preload" href="E" as="image" fetchpriority="high"><link rel="preload" href="7" as="image" fetchpriority="high"><link rel="preload" href="%" as="image" fetchpriority="high"><link rel="preload" href="B" as="image" fetchpriority="high"><link rel="preload" href="A" as="image" fetchpriority="high"><link rel="preload" href="%" as="image" fetchpriority="high"><link rel="preload" href="A" as="image" fetchpriority="high"><link rel="preload" href="7" as="image" fetchpriority="high"><link rel="preload" href="%" as="image" fetchpriority="high"><link rel="preload" href="E" as="image" fetchpriority="high"><link rel="preload" href="5" as="image" fetchpriority="high"><link rel="preload" href="%" as="image" fetchpriority="high"><link rel="preload" href="8" as="image" fetchpriority="high"><link rel="preload" href="8" as="image" fetchpriority="high"><link rel="preload" href="%" as="image" fetchpriority="high"><link rel="preload" href="A" as="image" fetchpriority="high"><link rel="preload" href="B" as="image" fetchpriority="high"><link rel="preload" href="%" as="image" fetchpriority="high"><link rel="preload" href="E" as="image" fetchpriority="high"><link rel="preload" href="9" as="image" fetchpriority="high"><link rel="preload" href="%" as="image" fetchpriority="high"><link rel="preload" href="8" as="image" fetchpriority="high"><link rel="preload" href="0" as="image" fetchpriority="high"><link rel="preload" href="%" as="image" fetchpriority="high"><link rel="preload" href="9" as="image" fetchpriority="high"><link rel="preload" href="A" as="image" fetchpriority="high"><link rel="preload" href="%" as="image" fetchpriority="high"><link rel="preload" href="E" as="image" fetchpriority="high"><link rel="preload" href="5" as="image" fetchpriority="high"><link rel="preload" href="%" as="image" fetchpriority="high"><link rel="preload" href="8" as="image" fetchpriority="high"><link rel="preload" href="5" as="image" fetchpriority="high"><link rel="preload" href="%" as="image" fetchpriority="high"><link rel="preload" href="B" as="image" fetchpriority="high"><link rel="preload" href="3" as="image" fetchpriority="high"><link rel="preload" href="/" as="image" fetchpriority="high"><link rel="preload" href="d" as="image" fetchpriority="high"><link rel="preload" href="v" as="image" fetchpriority="high"><link rel="preload" href="w" as="image" fetchpriority="high"><link rel="preload" href="a" as="image" fetchpriority="high"><link rel="preload" href="." as="image" fetchpriority="high"><link rel="preload" href="p" as="image" fetchpriority="high"><link rel="preload" href="n" as="image" fetchpriority="high"><link rel="preload" href="g" as="image" fetchpriority="high"><meta name="keywords" content="Web安全,DVWA"><meta name="description" content="Web安全入门靶场，巩固基础"><link rel="canonical" href="https://ph0ven1x.github.io/2024/05/16/DVWA%E5%85%A8%E7%BA%A7%E5%88%AB%E9%80%9A%E5%85%B3/"><title>DVWA全级别通关</title><meta name="generator" content="Hexo 7.0.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">DVWA全级别通关</h1><div class="meta"><span class="item" title="创建时间：2024-05-16 15:06:49"><span class="icon"><i class="ic i-calendar"></i></span><span class="text">发表于</span><time itemprop="dateCreated datePublished" datetime="2024-05-16T15:06:49+08:00">2024-05-16</time></span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i></span><span class="text">本文字数</span><span>22k</span><span class="text">字</span></span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i></span><span class="text">阅读时长</span><span>20 分钟</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span><span class="line"></span><span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">ph0ven1x</a></li></ul><ul class="right" id="rightNav"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div class="pjax" id="imgs"><img src="/2024/05/16/DVWA%E5%85%A8%E7%BA%A7%E5%88%AB%E9%80%9A%E5%85%B3/dvwa.png" loading="eager" decoding="async" fetchpriority="high" alt="日拱一卒 功不唐捐"></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"></path></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"></use><use xlink:href="#gentle-wave" x="48" y="3"></use><use xlink:href="#gentle-wave" x="48" y="5"></use><use xlink:href="#gentle-wave" x="48" y="7"></use></g></svg></div><main><div class="inner"><div class="pjax" id="main"><div class="article wrap"><div class="breadcrumb" itemlistelement itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i><span><a href="/">首页</a></span><i class="ic i-angle-right"></i><span itemprop="itemListElement" itemscope="itemscope" itemtype="https://schema.org/ListItem"><a href="/categories/Web%E5%AE%89%E5%85%A8/" itemprop="item" rel="index" title="分类于Web安全"><span itemprop="name">Web安全<meta itemprop="position" content="0"></span></a></span><i class="ic i-angle-right"></i><span class="current" itemprop="itemListElement" itemscope="itemscope" itemtype="https://schema.org/ListItem"><a href="/categories/Web%E5%AE%89%E5%85%A8/%E5%9F%BA%E7%A1%80%E9%9D%B6%E5%9C%BA/" itemprop="item" rel="index" title="分类于基础靶场"><span itemprop="name">基础靶场<meta itemprop="position" content="1"></span></a></span></div><article class="post block" itemscope="itemscope" itemtype="http://schema.org/Article" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://ph0ven1x.github.io/2024/05/16/DVWA%E5%85%A8%E7%BA%A7%E5%88%AB%E9%80%9A%E5%85%B3/"><span hidden="hidden" itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="image" content="/assets/avatar.jpg"><meta itemprop="name" content="ph0ven1x"><meta itemprop="description" content=", 热爱技术，热爱生活"></span><span hidden="hidden" itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="日拱一卒 功不唐捐"></span><div class="body md" itemprop="articleBody"><h1 id="dvwa全级别通关"><a class="anchor" href="#dvwa全级别通关">#</a> DVWA 全级别通关</h1>
<h2 id="安装部署"><a class="anchor" href="#安装部署">#</a> 安装部署</h2>
<p>直接用 docker 拉个镜像即可</p>
<figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">sudo</span> <span class="token function">docker</span> pull vulnerables/web-dvwa:latest</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">sudo</span> <span class="token function">docker</span> run <span class="token parameter variable">-it</span> <span class="token parameter variable">-d</span> <span class="token parameter variable">-p</span> <span class="token number">8001</span>:80 <span class="token parameter variable">-p</span> <span class="token number">3336</span>:3306 vulnerables/web-dvwa</pre></td></tr></table></figure><p>装完以后发现，有点问题</p>
<ol>
<li><code>allow_url_include = Off</code></li>
</ol>
<figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 进入 dvwa 容器</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">sudo</span> <span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> <span class="token operator">&lt;</span>container id<span class="token operator">></span> <span class="token function">bash</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token function">grep</span> <span class="token parameter variable">-r</span> <span class="token string">'allow_url_include = Off'</span> / </pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 进入这个目录 /etc/php/7.0/apache2/php.ini:allow_url_include = Off 改这个即可</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment"># 没用 vim/vi 用 sed</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">'s/allow_url_include = Off/allow_url_include = On/g'</span> php.ini</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token function">service</span> apache2 restart</pre></td></tr></table></figure><ol start="2">
<li><code>reCAPTCHA key:Missing</code></li>
</ol>
<p>公钥和私钥自己去申请一下 选择 v2 复选框的版本：<br>
<a target="_blank" rel="noopener" href="https://www.google.com/recaptcha/admin/create">https://www.google.com/recaptcha/admin/create</a></p>
<figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 进入 dvwa 容器</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment"># 进入目录 /var/www/html/config/config.inc.php 改这个即可</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># 可以看一下公钥私钥字段的行数，我这里是 29 和 30 行</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 在 29 行前插入公钥</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token function">nl</span> config.inc.php <span class="token operator">|</span> <span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">"30i \<span class="token variable">$_DVWA</span>[ 'recaptcha_public_key' ]  = 'xxxxxxxxxxx...';"</span> config.inc.php</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment"># 在 30 行前插入私钥</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token function">nl</span> config.inc.php <span class="token operator">|</span> <span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">"30i \<span class="token variable">$_DVWA</span>[ 'recaptcha_private_key' ]  = 'xxxxxxxxxxx...';"</span> config.inc.php</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment"># 把以前的 31 行和 32 行删掉</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token function">nl</span> config.inc.php <span class="token operator">|</span> <span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">"31,32d"</span> config.inc.php</pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment"># 重启下 apache</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token function">service</span> apache2 restart</pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment"># 不放心的话也可以退出 dvwa docker 的系统，重启一下 dvwa 容器</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token builtin class-name">exit</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token function">sudo</span> <span class="token function">docker</span> restart <span class="token operator">&lt;</span>container id<span class="token operator">></span></pre></td></tr></table></figure><p>如下图这样就是配置成功了</p>
<p><img loading="lazy" data-src="image-sasa.png" alt=""></p>
<h2 id="暴力破解"><a class="anchor" href="#暴力破解">#</a> 暴力破解</h2>
<h3 id="low级"><a class="anchor" href="#low级">#</a> low 级</h3>
<p><img loading="lazy" data-src="image-20240515144908154.png" alt=""></p>
<p>先对代码进行审计，没有任何防爆机制</p>
<figure class="highlight php"><figcaption data-lang="PHP"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token php language-php"><span class="token delimiter important">&lt;?php</span></span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token keyword">isset</span><span class="token punctuation">(</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'Login'</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token comment">// Get username</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token variable">$user</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'username'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token comment">// Get password</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token variable">$pass</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'password'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token variable">$pass</span> <span class="token operator">=</span> <span class="token function">md5</span><span class="token punctuation">(</span> <span class="token variable">$pass</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token comment">// Check the database</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token variable">$query</span>  <span class="token operator">=</span> <span class="token string double-quoted-string">"SELECT * FROM `users` WHERE user = '<span class="token interpolation"><span class="token variable">$user</span></span>' AND password = '<span class="token interpolation"><span class="token variable">$pass</span></span>';"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token function">mysql_query</span><span class="token punctuation">(</span> <span class="token variable">$query</span> <span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token keyword">die</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'&lt;pre>'</span> <span class="token operator">.</span> <span class="token function">mysql_error</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'&lt;/pre>'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token variable">$result</span> <span class="token operator">&amp;&amp;</span> <span class="token function">mysql_num_rows</span><span class="token punctuation">(</span> <span class="token variable">$result</span> <span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token comment">// Get users details</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token variable">$avatar</span> <span class="token operator">=</span> <span class="token function">mysql_result</span><span class="token punctuation">(</span> <span class="token variable">$result</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"avatar"</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token comment">// Login successful</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"&lt;p>Welcome to the password protected area <span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token variable">$user</span><span class="token punctuation">&#125;</span></span>&lt;/p>"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"&lt;img src=\"<span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token variable">$avatar</span><span class="token punctuation">&#125;</span></span>\" />"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token comment">// Login failed</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"&lt;pre>&lt;br />Username and/or password incorrect.&lt;/pre>"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token function">mysql_close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token delimiter important">?></span></pre></td></tr></table></figure><p>随便输入用户名和密码，然后用 BurpSuite 抓包，点击登录，抓到包以后发送到 Intruder 模块，攻击类型选择 Cluster Bomb，将用户名和密码设置为变量。（这里用 Sniper 就行，选取密码这一个变量进行爆破，因为已经知道用户名 admin）</p>
<p><img loading="lazy" data-src="image-20240515151306315.png" alt="image-20240515151306315"></p>
<blockquote>
<p>[!IMPORTANT]</p>
<p>攻击类型：</p>
<ul>
<li>
<p>Sniper (狙击手)：可以设置任意多的变量，但只能设置一个 payload。所有变量都是使用一个 payload，当对一个变量进行爆破时，其他变量值保持不变，然后根据变量的顺序依次爆破。</p>
<p>对于用户名和密码的爆破，常用于已经知道了用户名或密码中的一个，去爆破另一个。</p>
</li>
<li>
<p>Batter ram (攻城锤)：可以设置任意多的变量，但只能设置一个 payload。所有变量都是使用一个 payload，同时爆破变量。</p>
<p>与 Sniper 类似，唯一的区别是，不是根据变量的顺序进行依次爆破，而是同时爆破所有变量。</p>
<p>对于用户名和密码的爆破不适用，使用这种攻击类型，每次爆破用户名和密码都是一样的。</p>
</li>
<li>
<p>Pitchfork (干草叉)：可以设置任意多的变量，每个变量都可以设置不同的 payload。爆破时，所有变量同时进行爆破，也就是说，变量每次读取的是对应 payload 中同一行的字段。例如，在爆破用户名和密码时，设置了两个 payload，第一行的用户名只能匹配第一行的密码，第二行的用户名只能匹配第二行的密码，以此类推... 这种攻击类型对于爆破用户名和密码是不完全的，仅仅只是把同一行的用户名和密码进行匹配，没有交错匹配。</p>
</li>
<li>
<p>Cluster Bomb (集束炸弹)：可以设置任意多的变量，每个变量都可以设置不同的 payload。爆破时，会尝试所有组合。（笛卡尔积）</p>
<p>以爆破用户名和密码为例，用户名变量为 payload1，密码变量为 payload2，用户名变量会读取 payload1 中的第一行时，密码变量读取 payload2 中的第一行；用户名变量会读取 payload1 中的第二行时，密码变量仍读取 payload2 中的第一行... 依次类推，直到 payload1 中的字段被读取完毕，密码才开始读取 payload2 中的第二行... 依次类推，直到所有用户名和密码的组合都尝试过一边。这可以说是 Pitchfork 的升级版，用户名和密码会交错匹配，尝试所有组合，但耗时间。</p>
</li>
</ul>
</blockquote>
<p>然后进行 payload 设置，分别对 payload1 和 payload2 设置字典，点击 start attack 开始爆破</p>
<p><img loading="lazy" data-src="image-20240515160713818.png" alt="image-20240515160713818"></p>
<p>看返回的长度可以确认真实的用户名和密码</p>
<p><img loading="lazy" data-src="image-20240515165105834.png" alt="image-20240515165105834"></p>
<p>或者选择筛选，我们从源码中可以看见登录成功时返回字段 <code>Username and/or password incorrect.</code></p>
<p><img loading="lazy" data-src="image-20240516140040131.png" alt="image-20240516140040131"></p>
<p><img loading="lazy" data-src="image-20240516140057072.png" alt="image-20240516140057072"></p>
<p>用户名：admin 密码：password （用户名不区分大小写）到此 low 级结束。</p>
<p><img loading="lazy" data-src="image-20240515172535555.png" alt="image-20240515172535555"></p>
<h3 id="medium级"><a class="anchor" href="#medium级">#</a> medium 级</h3>
<p>先进行代码审计</p>
<figure class="highlight php"><figcaption data-lang="PHP"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token php language-php"><span class="token delimiter important">&lt;?php</span></span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token keyword">isset</span><span class="token punctuation">(</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'Login'</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token comment">// Sanitise username input</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token variable">$user</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'username'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token variable">$user</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">is_object</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">mysqli_real_escape_string</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token variable">$user</span> <span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">trigger_error</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span><span class="token punctuation">,</span> <span class="token constant">E_USER_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string double-quoted-string">""</span> <span class="token punctuation">:</span> <span class="token string double-quoted-string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token comment">// Sanitise password input</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token variable">$pass</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'password'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token variable">$pass</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">is_object</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">mysqli_real_escape_string</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token variable">$pass</span> <span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">trigger_error</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span><span class="token punctuation">,</span> <span class="token constant">E_USER_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string double-quoted-string">""</span> <span class="token punctuation">:</span> <span class="token string double-quoted-string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token variable">$pass</span> <span class="token operator">=</span> <span class="token function">md5</span><span class="token punctuation">(</span> <span class="token variable">$pass</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token comment">// Check the database</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token variable">$query</span>  <span class="token operator">=</span> <span class="token string double-quoted-string">"SELECT * FROM `users` WHERE user = '<span class="token interpolation"><span class="token variable">$user</span></span>' AND password = '<span class="token interpolation"><span class="token variable">$pass</span></span>';"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token function">mysqli_query</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token variable">$query</span> <span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token keyword">die</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'&lt;pre>'</span> <span class="token operator">.</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">is_object</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">mysqli_error</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">$___mysqli_res</span> <span class="token operator">=</span> <span class="token function">mysqli_connect_error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token variable">$___mysqli_res</span> <span class="token punctuation">:</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'&lt;/pre>'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token variable">$result</span> <span class="token operator">&amp;&amp;</span> <span class="token function">mysqli_num_rows</span><span class="token punctuation">(</span> <span class="token variable">$result</span> <span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token comment">// Get users details</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token variable">$row</span>    <span class="token operator">=</span> <span class="token function">mysqli_fetch_assoc</span><span class="token punctuation">(</span> <span class="token variable">$result</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token variable">$avatar</span> <span class="token operator">=</span> <span class="token variable">$row</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"avatar"</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token comment">// Login successful</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"&lt;p>Welcome to the password protected area <span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token variable">$user</span><span class="token punctuation">&#125;</span></span>&lt;/p>"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"&lt;img src=\"<span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token variable">$avatar</span><span class="token punctuation">&#125;</span></span>\" />"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token comment">// Login failed</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token function">sleep</span><span class="token punctuation">(</span> <span class="token number">2</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"&lt;pre>&lt;br />Username and/or password incorrect.&lt;/pre>"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">is_null</span><span class="token punctuation">(</span><span class="token variable">$___mysqli_res</span> <span class="token operator">=</span> <span class="token function">mysqli_close</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token constant boolean">false</span> <span class="token punctuation">:</span> <span class="token variable">$___mysqli_res</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="34"></td><td><pre></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token delimiter important">?></span></pre></td></tr></table></figure><p>相比 low，medium 增加了 <code>mysqli_real_escape_string()</code>  函数，这个函数用于转义字符串中的特殊字符，以防止与 MySQL 数据库交互时发生 SQL 注入攻击。这个函数接收两个参数，第一个参数是数据库的连接对象，第二个参数是需要转义的字符串。还在登录失败后增加了 sleep (2) 睡眠 2 秒，增加了暴力破解的时间。因此，对暴力破解还是没有实质性的防治措施，用 low 级的方法就能可以了，就不再演示。</p>
<h3 id="high级"><a class="anchor" href="#high级">#</a> high 级</h3>
<p>先进行代码审计</p>
<figure class="highlight php"><figcaption data-lang="PHP"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token php language-php"><span class="token delimiter important">&lt;?php</span></span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token keyword">isset</span><span class="token punctuation">(</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'Login'</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token comment">// Check Anti-CSRF token</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token function">checkToken</span><span class="token punctuation">(</span> <span class="token variable">$_REQUEST</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'user_token'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$_SESSION</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'session_token'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'index.php'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token comment">// Sanitise username input</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token variable">$user</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'username'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token variable">$user</span> <span class="token operator">=</span> <span class="token function">stripslashes</span><span class="token punctuation">(</span> <span class="token variable">$user</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token variable">$user</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">is_object</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">mysqli_real_escape_string</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token variable">$user</span> <span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">trigger_error</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span><span class="token punctuation">,</span> <span class="token constant">E_USER_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string double-quoted-string">""</span> <span class="token punctuation">:</span> <span class="token string double-quoted-string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token comment">// Sanitise password input</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token variable">$pass</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'password'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token variable">$pass</span> <span class="token operator">=</span> <span class="token function">stripslashes</span><span class="token punctuation">(</span> <span class="token variable">$pass</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token variable">$pass</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">is_object</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">mysqli_real_escape_string</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token variable">$pass</span> <span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">trigger_error</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span><span class="token punctuation">,</span> <span class="token constant">E_USER_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string double-quoted-string">""</span> <span class="token punctuation">:</span> <span class="token string double-quoted-string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token variable">$pass</span> <span class="token operator">=</span> <span class="token function">md5</span><span class="token punctuation">(</span> <span class="token variable">$pass</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token comment">// Check database</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token variable">$query</span>  <span class="token operator">=</span> <span class="token string double-quoted-string">"SELECT * FROM `users` WHERE user = '<span class="token interpolation"><span class="token variable">$user</span></span>' AND password = '<span class="token interpolation"><span class="token variable">$pass</span></span>';"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token function">mysqli_query</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token variable">$query</span> <span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token keyword">die</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'&lt;pre>'</span> <span class="token operator">.</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">is_object</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">mysqli_error</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">$___mysqli_res</span> <span class="token operator">=</span> <span class="token function">mysqli_connect_error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token variable">$___mysqli_res</span> <span class="token punctuation">:</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'&lt;/pre>'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token variable">$result</span> <span class="token operator">&amp;&amp;</span> <span class="token function">mysqli_num_rows</span><span class="token punctuation">(</span> <span class="token variable">$result</span> <span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token comment">// Get users details</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token variable">$row</span>    <span class="token operator">=</span> <span class="token function">mysqli_fetch_assoc</span><span class="token punctuation">(</span> <span class="token variable">$result</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token variable">$avatar</span> <span class="token operator">=</span> <span class="token variable">$row</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"avatar"</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token comment">// Login successful</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"&lt;p>Welcome to the password protected area <span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token variable">$user</span><span class="token punctuation">&#125;</span></span>&lt;/p>"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"&lt;img src=\"<span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token variable">$avatar</span><span class="token punctuation">&#125;</span></span>\" />"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        <span class="token comment">// Login failed</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token function">sleep</span><span class="token punctuation">(</span> <span class="token function">rand</span><span class="token punctuation">(</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"&lt;pre>&lt;br />Username and/or password incorrect.&lt;/pre>"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="36"></td><td><pre></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">is_null</span><span class="token punctuation">(</span><span class="token variable">$___mysqli_res</span> <span class="token operator">=</span> <span class="token function">mysqli_close</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token constant boolean">false</span> <span class="token punctuation">:</span> <span class="token variable">$___mysqli_res</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="39"></td><td><pre></pre></td></tr><tr><td data-num="40"></td><td><pre><span class="token comment">// Generate Anti-CSRF token</span></pre></td></tr><tr><td data-num="41"></td><td><pre><span class="token function">generateSessionToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre></pre></td></tr><tr><td data-num="43"></td><td><pre><span class="token delimiter important">?></span></pre></td></tr></table></figure><p><code>generateSessionToken();</code>  根据注释可以理解：用于生成反 CSRF 令牌</p>
<p>​	这段代码放到最后，说明无论登录成功或失败，他都会生成新的 <code>session_token</code></p>
<p><code> checkToken( $_REQUEST[ 'user_token' ], $_SESSION[ 'session_token' ], 'index.php' );</code></p>
<p>​	根据注释可以理解：检查反 CSRF 令牌。</p>
<p>​	我们详细分析一下。（这里先不分析 CSRF，就针对暴力破解来分析。）</p>
<p>​	Session 意思是会话。当用户访问服务器，就开始了一次会话，这个时候服务器为用户生成一个 session（会话），sessionID 表示这	个会话的唯一标识。</p>
<p>​	 <code>$_SESSION[ 'session_token' ]</code>  读取 <code>generateSessionToken()</code>  生成的会话令牌 ( <code>session_token</code> )</p>
<p>​	 <code>$_REQUEST[ 'user_token' ]</code>  读取请求中的用户令牌（ <code>user_token</code> ）</p>
<p>​	我们无法查看 checkToken () 函数的源码，但可以确定是检测 user_token 和 session_token 的，如果这个函数检查不通过用户名和密码正确也登录不了。</p>
<p><code>generateSessionToken()</code>  生成 session_token 是放在服务端进行的，即使我们反复登录，checkToken () 也能正确的读取 session_token, 因此不是影响暴力破解的因素。</p>
<p>影响暴力破解的因素就是 user_token，只要每次都能获取正确的 user_token，便可完成暴力破解。</p>
<p>我们在该页面，右键查看源代码可见 <code>user_token</code> ，在刷新时，这个 <code>user_token</code>  是会发生改变的。</p>
<p><img loading="lazy" data-src="image-20240516114145902.png" alt="image-20240516114145902"></p>
<p>打开 BurpSuite 抓包，输入用户名 admin，密码随便输，点击登录，将抓到的结果发送到 Intruder</p>
<p>选择 Pitchfork 攻击类型，选取密码和 user_token 作为变量</p>
<p><img loading="lazy" data-src="image-20240516130231157.png" alt="image-20240516130231157"></p>
<p>先点击 Setting 选项卡，找到 Grep-Extract（提取响应消息中的有用信息），点击 Add, 点击 refetch response, 双击 token 值，点 ok</p>
<p><img loading="lazy" data-src="image-20240516133012978.png" alt="image-20240516133012978"></p>
<p>往下翻，Redirections 设置为 Always，这个配置是说攻击时，Burp Suite 怎么处理重定向，配置成总是跟随重定向</p>
<p><img loading="lazy" data-src="image-20240516133753597.png" alt="image-20240516133753597"></p>
<p>再设置 Resource pool，因为 Recursive_Grep 模式不支持多线程攻击。</p>
<p>老版本的 BurpSuite 是 option 下的 Request Engine。</p>
<p>将攻击线程设置为 1，请求间隔设置为 2000ms</p>
<p><img loading="lazy" data-src="image-20240516133455132.png" alt="image-20240516133455132"></p>
<p>设置 payload 1，跟前面一样导入密码字典就行</p>
<p>设置 payload2，注意 payload 类型，填上刚才抓包的 user_token 作为初始 payload，配置完就可以开始攻击了</p>
<p><img loading="lazy" data-src="image-20240516140842169.png" alt="image-20240516140842169"></p>
<p>两种方法确定密码，一是反选，就是把反选登录失败时的字段 Username and/or password incorrect.</p>
<p><img loading="lazy" data-src="image-20240516142843489.png" alt="image-20240516142843489"></p>
<p><img loading="lazy" data-src="image-20240516142927133.png" alt="image-20240516142927133"></p>
<p>二是看响应长度，最长那个就是</p>
<p><img loading="lazy" data-src="image-20240516143004429.png" alt="image-20240516143004429"></p>
<p>到此 high 级暴力破解完成。</p>
<h3 id="impossible级"><a class="anchor" href="#impossible级">#</a> impossible 级</h3>
<p>针对暴力破解，GET 提交方式改为 POST 提交方式，也加入了 token 校验，同时限制登录次数，如果登录失败三次账户就会被锁定，需要等待 15 分钟才能尝试。</p>
<figure class="highlight php"><figcaption data-lang="PHP"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token php language-php"><span class="token delimiter important">&lt;?php</span></span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token keyword">isset</span><span class="token punctuation">(</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'Login'</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">isset</span> <span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'username'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">isset</span> <span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'password'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token comment">// 检查 token</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token function">checkToken</span><span class="token punctuation">(</span> <span class="token variable">$_REQUEST</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'user_token'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$_SESSION</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'session_token'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'index.php'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token comment">// 用户名输入保护措施，过滤一些特殊字符</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token variable">$user</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'username'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token variable">$user</span> <span class="token operator">=</span> <span class="token function">stripslashes</span><span class="token punctuation">(</span> <span class="token variable">$user</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 返回一个去除转义反斜线后的字符串（\' 转换为 ' 等等）。双反斜线（\\）被转换为单个反斜线（\）</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token variable">$user</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">is_object</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">mysqli_real_escape_string</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token variable">$user</span> <span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">trigger_error</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span><span class="token punctuation">,</span> <span class="token constant">E_USER_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string double-quoted-string">""</span> <span class="token punctuation">:</span> <span class="token string double-quoted-string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token comment">// 密码输入保护措施</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token variable">$pass</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'password'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token variable">$pass</span> <span class="token operator">=</span> <span class="token function">stripslashes</span><span class="token punctuation">(</span> <span class="token variable">$pass</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token variable">$pass</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">is_object</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">mysqli_real_escape_string</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token variable">$pass</span> <span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">trigger_error</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span><span class="token punctuation">,</span> <span class="token constant">E_USER_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string double-quoted-string">""</span> <span class="token punctuation">:</span> <span class="token string double-quoted-string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token variable">$pass</span> <span class="token operator">=</span> <span class="token function">md5</span><span class="token punctuation">(</span> <span class="token variable">$pass</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token comment">// 默认值，失败次数，锁定时间，账户是否锁定</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token variable">$total_failed_login</span> <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token variable">$lockout_time</span>       <span class="token operator">=</span> <span class="token number">15</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token variable">$account_locked</span>     <span class="token operator">=</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token comment">// 获取最近一次登录时间，还有失败登录次数</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token variable">$db</span><span class="token operator">-></span><span class="token function">prepare</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'SELECT failed_login, last_login FROM users WHERE user = (:user) LIMIT 1;'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token variable">$data</span><span class="token operator">-></span><span class="token function">bindParam</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">':user'</span><span class="token punctuation">,</span> <span class="token variable">$user</span><span class="token punctuation">,</span> <span class="token class-name static-context">PDO</span><span class="token operator">::</span><span class="token constant">PARAM_STR</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token variable">$data</span><span class="token operator">-></span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token variable">$row</span> <span class="token operator">=</span> <span class="token variable">$data</span><span class="token operator">-></span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token comment">// 查看用户是否被锁定</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token variable">$data</span><span class="token operator">-></span><span class="token function">rowCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span> <span class="token variable">$row</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'failed_login'</span> <span class="token punctuation">]</span> <span class="token operator">>=</span> <span class="token variable">$total_failed_login</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span>  <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token comment">// User locked out.  Note, using this method would allow for user enumeration!</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        <span class="token comment">//echo "&lt;pre>&lt;br />This account has been locked due to too many incorrect logins.&lt;/pre>";</span></pre></td></tr><tr><td data-num="33"></td><td><pre></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token comment">// 计算何时允许用户再次登录</span></pre></td></tr><tr><td data-num="35"></td><td><pre>        <span class="token variable">$last_login</span> <span class="token operator">=</span> <span class="token function">strtotime</span><span class="token punctuation">(</span> <span class="token variable">$row</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'last_login'</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>        <span class="token variable">$timeout</span>    <span class="token operator">=</span> <span class="token variable">$last_login</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token variable">$lockout_time</span> <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>        <span class="token variable">$timenow</span>    <span class="token operator">=</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre></pre></td></tr><tr><td data-num="39"></td><td><pre>        <span class="token comment">/*</span></pre></td></tr><tr><td data-num="40"></td><td><pre>        print "The last login was: " . date ("h:i:s", $last_login) . "&lt;br />";</pre></td></tr><tr><td data-num="41"></td><td><pre>        print "The timenow is: " . date ("h:i:s", $timenow) . "&lt;br />";</pre></td></tr><tr><td data-num="42"></td><td><pre>        print "The timeout is: " . date ("h:i:s", $timeout) . "&lt;br />";</pre></td></tr><tr><td data-num="43"></td><td><pre>        */</pre></td></tr><tr><td data-num="44"></td><td><pre></pre></td></tr><tr><td data-num="45"></td><td><pre>        <span class="token comment">// 检查是否已经过去了足够的时间，如果它没有锁定帐户</span></pre></td></tr><tr><td data-num="46"></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token variable">$timenow</span> <span class="token operator">&lt;</span> <span class="token variable">$timeout</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>            <span class="token variable">$account_locked</span> <span class="token operator">=</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>            <span class="token comment">// print "The account is locked&lt;br />";</span></pre></td></tr><tr><td data-num="49"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="51"></td><td><pre></pre></td></tr><tr><td data-num="52"></td><td><pre>    <span class="token comment">// 检查数据库（如果用户名与密码匹配）</span></pre></td></tr><tr><td data-num="53"></td><td><pre>    <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token variable">$db</span><span class="token operator">-></span><span class="token function">prepare</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'SELECT * FROM users WHERE user = (:user) AND password = (:password) LIMIT 1;'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>    <span class="token variable">$data</span><span class="token operator">-></span><span class="token function">bindParam</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">':user'</span><span class="token punctuation">,</span> <span class="token variable">$user</span><span class="token punctuation">,</span> <span class="token class-name static-context">PDO</span><span class="token operator">::</span><span class="token constant">PARAM_STR</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>    <span class="token variable">$data</span><span class="token operator">-></span><span class="token function">bindParam</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">':password'</span><span class="token punctuation">,</span> <span class="token variable">$pass</span><span class="token punctuation">,</span> <span class="token class-name static-context">PDO</span><span class="token operator">::</span><span class="token constant">PARAM_STR</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>    <span class="token variable">$data</span><span class="token operator">-></span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>    <span class="token variable">$row</span> <span class="token operator">=</span> <span class="token variable">$data</span><span class="token operator">-></span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="58"></td><td><pre></pre></td></tr><tr><td data-num="59"></td><td><pre>    <span class="token comment">// 如果是有效的登录...</span></pre></td></tr><tr><td data-num="60"></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token variable">$data</span><span class="token operator">-></span><span class="token function">rowCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span> <span class="token variable">$account_locked</span> <span class="token operator">==</span> <span class="token constant boolean">false</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>        <span class="token comment">// 获得用户信息</span></pre></td></tr><tr><td data-num="62"></td><td><pre>        <span class="token variable">$avatar</span>       <span class="token operator">=</span> <span class="token variable">$row</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'avatar'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>        <span class="token variable">$failed_login</span> <span class="token operator">=</span> <span class="token variable">$row</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'failed_login'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>        <span class="token variable">$last_login</span>   <span class="token operator">=</span> <span class="token variable">$row</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'last_login'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="65"></td><td><pre></pre></td></tr><tr><td data-num="66"></td><td><pre>        <span class="token comment">// 登录成功</span></pre></td></tr><tr><td data-num="67"></td><td><pre>        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"&lt;p>Welcome to the password protected area &lt;em><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token variable">$user</span><span class="token punctuation">&#125;</span></span>&lt;/em>&lt;/p>"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"&lt;img src=\"<span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token variable">$avatar</span><span class="token punctuation">&#125;</span></span>\" />"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="69"></td><td><pre></pre></td></tr><tr><td data-num="70"></td><td><pre>        <span class="token comment">// 自上次登录以来，帐户是否被锁定？</span></pre></td></tr><tr><td data-num="71"></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token variable">$failed_login</span> <span class="token operator">>=</span> <span class="token variable">$total_failed_login</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="72"></td><td><pre>            <span class="token keyword">echo</span> <span class="token string double-quoted-string">"&lt;p>&lt;em>Warning&lt;/em>: Someone might of been brute forcing your account.&lt;/p>"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>            <span class="token keyword">echo</span> <span class="token string double-quoted-string">"&lt;p>Number of login attempts: &lt;em><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token variable">$failed_login</span><span class="token punctuation">&#125;</span></span>&lt;/em>.&lt;br />Last login attempt was at: &lt;em>$&#123;last_login&#125;&lt;/em>.&lt;/p>"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="74"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="75"></td><td><pre></pre></td></tr><tr><td data-num="76"></td><td><pre>        <span class="token comment">// 重置错误的登录计数</span></pre></td></tr><tr><td data-num="77"></td><td><pre>        <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token variable">$db</span><span class="token operator">-></span><span class="token function">prepare</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'UPDATE users SET failed_login = "0" WHERE user = (:user) LIMIT 1;'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="78"></td><td><pre>        <span class="token variable">$data</span><span class="token operator">-></span><span class="token function">bindParam</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">':user'</span><span class="token punctuation">,</span> <span class="token variable">$user</span><span class="token punctuation">,</span> <span class="token class-name static-context">PDO</span><span class="token operator">::</span><span class="token constant">PARAM_STR</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="79"></td><td><pre>        <span class="token variable">$data</span><span class="token operator">-></span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="80"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="81"></td><td><pre>        <span class="token comment">// 登录失败</span></pre></td></tr><tr><td data-num="82"></td><td><pre>        <span class="token function">sleep</span><span class="token punctuation">(</span> <span class="token function">rand</span><span class="token punctuation">(</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="83"></td><td><pre></pre></td></tr><tr><td data-num="84"></td><td><pre>        <span class="token comment">// 用户反馈</span></pre></td></tr><tr><td data-num="85"></td><td><pre>        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"&lt;pre>&lt;br />Username and/or password incorrect.&lt;br />&lt;br/>Alternative, the account has been locked because of too many failed logins.&lt;br />If this is the case, &lt;em>please try again in <span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token variable">$lockout_time</span><span class="token punctuation">&#125;</span></span> minutes&lt;/em>.&lt;/pre>"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="86"></td><td><pre></pre></td></tr><tr><td data-num="87"></td><td><pre>        <span class="token comment">// 更新错误登录计数</span></pre></td></tr><tr><td data-num="88"></td><td><pre>        <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token variable">$db</span><span class="token operator">-></span><span class="token function">prepare</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'UPDATE users SET failed_login = (failed_login + 1) WHERE user = (:user) LIMIT 1;'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="89"></td><td><pre>        <span class="token variable">$data</span><span class="token operator">-></span><span class="token function">bindParam</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">':user'</span><span class="token punctuation">,</span> <span class="token variable">$user</span><span class="token punctuation">,</span> <span class="token class-name static-context">PDO</span><span class="token operator">::</span><span class="token constant">PARAM_STR</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="90"></td><td><pre>        <span class="token variable">$data</span><span class="token operator">-></span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="91"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="92"></td><td><pre></pre></td></tr><tr><td data-num="93"></td><td><pre>    <span class="token comment">// 设置上次登录时间</span></pre></td></tr><tr><td data-num="94"></td><td><pre>    <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token variable">$db</span><span class="token operator">-></span><span class="token function">prepare</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'UPDATE users SET last_login = now() WHERE user = (:user) LIMIT 1;'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="95"></td><td><pre>    <span class="token variable">$data</span><span class="token operator">-></span><span class="token function">bindParam</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">':user'</span><span class="token punctuation">,</span> <span class="token variable">$user</span><span class="token punctuation">,</span> <span class="token class-name static-context">PDO</span><span class="token operator">::</span><span class="token constant">PARAM_STR</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="96"></td><td><pre>    <span class="token variable">$data</span><span class="token operator">-></span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="97"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="98"></td><td><pre></pre></td></tr><tr><td data-num="99"></td><td><pre><span class="token comment">// 生成 session token</span></pre></td></tr><tr><td data-num="100"></td><td><pre><span class="token function">generateSessionToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="101"></td><td><pre></pre></td></tr><tr><td data-num="102"></td><td><pre><span class="token delimiter important">?></span></pre></td></tr></table></figure><h3 id="总结"><a class="anchor" href="#总结">#</a> 总结</h3>
<p>对于暴力破解，可以通过设置 token、设定登录失败次数的阈值、设置验证码等来进行防御。</p>
<p>对于攻击者来说，社工才是更好的选择。</p>
<p>这个靶场主要练习了 BurpSuite 的抓包，Intruder 模块，熟练使用不同的攻击类型，以及根据情况配置不同的 payload，PHP 代码审计也至关重要，仍需继续努力...</p>
<ul>
<li>
<p>Burp Suite</p>
<ul>
<li>proxy 模块</li>
<li>intruder 模块
<ul>
<li>4 种攻击类型</li>
<li>抓取重要响应内容配置 payload</li>
</ul>
</li>
</ul>
</li>
<li>
<p>暴力破解防范措施</p>
</li>
<li>
<p>php 代码审计</p>
</li>
</ul>
<h2 id="命令注入"><a class="anchor" href="#命令注入">#</a> 命令注入</h2>
<h3 id="low级-2"><a class="anchor" href="#low级-2">#</a> low 级</h3>
<p>先进行代码审计</p>
<figure class="highlight php"><figcaption data-lang="PHP"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token php language-php"><span class="token delimiter important">&lt;?php</span></span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token keyword">isset</span><span class="token punctuation">(</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'Submit'</span> <span class="token punctuation">]</span>  <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token comment">// Get input</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token variable">$target</span> <span class="token operator">=</span> <span class="token variable">$_REQUEST</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'ip'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token comment">// Determine OS and execute the ping command.</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">stristr</span><span class="token punctuation">(</span> <span class="token function">php_uname</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'s'</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'Windows NT'</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token comment">// Windows</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token variable">$cmd</span> <span class="token operator">=</span> <span class="token function">shell_exec</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'ping  '</span> <span class="token operator">.</span> <span class="token variable">$target</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token comment">// *nix</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token variable">$cmd</span> <span class="token operator">=</span> <span class="token function">shell_exec</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'ping  -c 4 '</span> <span class="token operator">.</span> <span class="token variable">$target</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token comment">// Feedback for the end user</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token keyword">echo</span> <span class="token string double-quoted-string">"&lt;pre><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token variable">$cmd</span><span class="token punctuation">&#125;</span></span>&lt;/pre>"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token delimiter important">?></span></pre></td></tr></table></figure><p>这段代码就是根据输入的 ip 地址，然后判断系统是 Linux 还是 Windows 然后对 IP 执行 ping 命令。</p>
<p>没有对数据进行任何过滤，非常危险。</p>
<blockquote>
<p>[!IMPORTANT]</p>
<p>下面符号在 Linux 和 Windows 中用法一致</p>
<p><code>&amp;&amp;</code> ： <code>command1 &amp;&amp; command2</code> ，如果 command1 执行成功，才会执行 <code>command2</code> ，如果 <code>command2</code>  执行失败， <code>command2</code>  不执行</p>
<p><code>&amp;</code> ： <code>command1 &amp; command2</code> ，先执行 <code>command1</code> ，再执行 <code>command2</code> ，无论 <code>command1</code>  执行是否成功， <code>command2</code>  都执行</p>
<p><code>||</code> ： <code>command1 || command2</code> ，如果 commad1 执行成功，则 command2 不执行，只有 command1 执行失败，command2 才执行</p>
<p><code>|</code> ：管道命令，常用作过滤，把前一个命令执行结果作为后一个命令的执行输入，例如： <code>cat /etc/passwd |grep &quot;root&quot;</code>   <code>command1 |command2</code> ：如果 command2 不需要输入，那么不管 <code>command1</code>  是什么，结果是 command2 的执行结果 `</p>
<p><code>;</code> ： <code>command1;commadn2</code> ：按顺序执行，先执行 <code>command1</code>  再执行 <code>command2</code></p>
</blockquote>
<p>输入一个能 ping 的通的 ip</p>
<figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token number">192.168</span>.222.133 <span class="token operator">&amp;&amp;</span> <span class="token function">cat</span> /etc/passwd <span class="token comment">#linux 查看所有用户</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token number">192.168</span>.222.133 <span class="token operator">&amp;&amp;</span> net user        <span class="token comment">#win 查看所有用户</span></pre></td></tr></table></figure><p><img loading="lazy" data-src="image-20240517135256776.png" alt="image-20240517135256776"></p>
<p>输入一个 ping 不通的 IP</p>
<figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token number">192.168</span>.199.188 <span class="token operator">||</span> <span class="token function">cat</span> /etc/passwd</pre></td></tr></table></figure><p><img loading="lazy" data-src="image-20240517140109742.png" alt="image-20240517140109742"></p>
<p>随便输入一个 IP，无论是否能 ping 通</p>
<figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token number">192.168</span>.232.123<span class="token punctuation">;</span><span class="token function">cat</span> /etc/passwd</pre></td></tr></table></figure><p><img loading="lazy" data-src="image-20240517141420896.png" alt="image-20240517141420896"></p>
<h3 id="medium级-2"><a class="anchor" href="#medium级-2">#</a> medium 级</h3>
<p>先代码审计</p>
<figure class="highlight php"><figcaption data-lang="PHP"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token php language-php"><span class="token delimiter important">&lt;?php</span></span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token keyword">isset</span><span class="token punctuation">(</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'Submit'</span> <span class="token punctuation">]</span>  <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token comment">// Get input</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token variable">$target</span> <span class="token operator">=</span> <span class="token variable">$_REQUEST</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'ip'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token comment">// Set blacklist</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token variable">$substitutions</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token string single-quoted-string">'&amp;&amp;'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token string single-quoted-string">';'</span>  <span class="token operator">=></span> <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token comment">// Remove any of the charactars in the array (blacklist).</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token variable">$target</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span> <span class="token function">array_keys</span><span class="token punctuation">(</span> <span class="token variable">$substitutions</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">$substitutions</span><span class="token punctuation">,</span> <span class="token variable">$target</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token comment">// Determine OS and execute the ping command.</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">stristr</span><span class="token punctuation">(</span> <span class="token function">php_uname</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'s'</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'Windows NT'</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token comment">// Windows</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token variable">$cmd</span> <span class="token operator">=</span> <span class="token function">shell_exec</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'ping  '</span> <span class="token operator">.</span> <span class="token variable">$target</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token comment">// *nix</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token variable">$cmd</span> <span class="token operator">=</span> <span class="token function">shell_exec</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'ping  -c 4 '</span> <span class="token operator">.</span> <span class="token variable">$target</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token comment">// Feedback for the end user</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token keyword">echo</span> <span class="token string double-quoted-string">"&lt;pre><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token variable">$cmd</span><span class="token punctuation">&#125;</span></span>&lt;/pre>"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token delimiter important">?></span></pre></td></tr></table></figure><p>相比 low 级，增加了 <code>;</code>  和 <code>&amp;&amp;</code>  过滤，但是可以用其他连接符号</p>
<p>随便输入一个 IP，无论是否能 ping 通</p>
<figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token number">192.168</span>.232.123<span class="token punctuation">;</span><span class="token function">cat</span> /etc/passwd</pre></td></tr></table></figure><p><img loading="lazy" data-src="image-20240517143027045.png" alt="image-20240517143027045"></p>
<h3 id="high级-2"><a class="anchor" href="#high级-2">#</a> high 级</h3>
<p>先进行代码审计</p>
<figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token operator">&lt;</span>?php</pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre>if<span class="token punctuation">(</span> isset<span class="token punctuation">(</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span> <span class="token string">'Submit'</span> <span class="token punctuation">]</span>  <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    // Get input</pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token variable">$target</span> <span class="token operator">=</span> trim<span class="token punctuation">(</span><span class="token variable">$_REQUEST</span><span class="token punctuation">[</span> <span class="token string">'ip'</span> <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>    // Set blacklist</pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token variable">$substitutions</span> <span class="token operator">=</span> array<span class="token punctuation">(</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token string">'&amp;'</span>  <span class="token operator">=</span><span class="token operator">></span> <span class="token string">''</span>,</pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token string">';'</span>  <span class="token operator">=</span><span class="token operator">></span> <span class="token string">''</span>,</pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token string">'| '</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">''</span>,</pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token string">'-'</span>  <span class="token operator">=</span><span class="token operator">></span> <span class="token string">''</span>,</pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token string">'$'</span>  <span class="token operator">=</span><span class="token operator">></span> <span class="token string">''</span>,</pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token string">'('</span>  <span class="token operator">=</span><span class="token operator">></span> <span class="token string">''</span>,</pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token string">')'</span>  <span class="token operator">=</span><span class="token operator">></span> <span class="token string">''</span>,</pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token string">'`'</span>  <span class="token operator">=</span><span class="token operator">></span> <span class="token string">''</span>,</pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token string">'||'</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">''</span>,</pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>    // Remove any of the charactars <span class="token keyword">in</span> the array <span class="token punctuation">(</span>blacklist<span class="token punctuation">)</span>.</pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token variable">$target</span> <span class="token operator">=</span> str_replace<span class="token punctuation">(</span> array_keys<span class="token punctuation">(</span> <span class="token variable">$substitutions</span> <span class="token punctuation">)</span>, <span class="token variable">$substitutions</span>, <span class="token variable">$target</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre>    // Determine OS and execute the <span class="token function">ping</span> command.</pre></td></tr><tr><td data-num="24"></td><td><pre>    if<span class="token punctuation">(</span> stristr<span class="token punctuation">(</span> php_uname<span class="token punctuation">(</span> <span class="token string">'s'</span> <span class="token punctuation">)</span>, <span class="token string">'Windows NT'</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        // Windows</pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token variable">$cmd</span> <span class="token operator">=</span> shell_exec<span class="token punctuation">(</span> <span class="token string">'ping  '</span> <span class="token builtin class-name">.</span> <span class="token variable">$target</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        // *nix</pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token variable">$cmd</span> <span class="token operator">=</span> shell_exec<span class="token punctuation">(</span> <span class="token string">'ping  -c 4 '</span> <span class="token builtin class-name">.</span> <span class="token variable">$target</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre>    // Feedback <span class="token keyword">for</span> the end user</pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token builtin class-name">echo</span> <span class="token string">"&lt;pre>&#123;<span class="token variable">$cmd</span>&#125;&lt;/pre>"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="36"></td><td><pre></pre></td></tr><tr><td data-num="37"></td><td><pre>?<span class="token operator">></span></pre></td></tr></table></figure><p>high 级也是加了过滤，但是对管道符的过滤还多加了空格 <code>| </code> ，对管道符的过滤是无效的</p>
<p>随便输入一个 IP，无论能否 ping 通</p>
<pre><code>192.168.232.123|cat /etc/passwd
</code></pre>
<p><img loading="lazy" data-src="image-20240517143909575.png" alt="image-20240517143909575"></p>
<h3 id="impossible级-2"><a class="anchor" href="#impossible级-2">#</a> impossible 级</h3>
<figure class="highlight php"><figcaption data-lang="PHP"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token php language-php"><span class="token delimiter important">&lt;?php</span></span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token keyword">isset</span><span class="token punctuation">(</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'Submit'</span> <span class="token punctuation">]</span>  <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token comment">// Check Anti-CSRF token</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token function">checkToken</span><span class="token punctuation">(</span> <span class="token variable">$_REQUEST</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'user_token'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$_SESSION</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'session_token'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'index.php'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token comment">// Get input</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token variable">$target</span> <span class="token operator">=</span> <span class="token variable">$_REQUEST</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'ip'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token variable">$target</span> <span class="token operator">=</span> <span class="token function">stripslashes</span><span class="token punctuation">(</span> <span class="token variable">$target</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token comment">// Split the IP into 4 octects</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token variable">$octet</span> <span class="token operator">=</span> <span class="token function">explode</span><span class="token punctuation">(</span> <span class="token string double-quoted-string">"."</span><span class="token punctuation">,</span> <span class="token variable">$target</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token comment">// Check IF each octet is an integer</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token function">is_numeric</span><span class="token punctuation">(</span> <span class="token variable">$octet</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span> <span class="token function">is_numeric</span><span class="token punctuation">(</span> <span class="token variable">$octet</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span> <span class="token function">is_numeric</span><span class="token punctuation">(</span> <span class="token variable">$octet</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span> <span class="token function">is_numeric</span><span class="token punctuation">(</span> <span class="token variable">$octet</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span> <span class="token function">sizeof</span><span class="token punctuation">(</span> <span class="token variable">$octet</span> <span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">4</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token comment">// If all 4 octets are int's put the IP back together.</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token variable">$target</span> <span class="token operator">=</span> <span class="token variable">$octet</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'.'</span> <span class="token operator">.</span> <span class="token variable">$octet</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'.'</span> <span class="token operator">.</span> <span class="token variable">$octet</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'.'</span> <span class="token operator">.</span> <span class="token variable">$octet</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token comment">// Determine OS and execute the ping command.</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">stristr</span><span class="token punctuation">(</span> <span class="token function">php_uname</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'s'</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'Windows NT'</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>            <span class="token comment">// Windows</span></pre></td></tr><tr><td data-num="22"></td><td><pre>            <span class="token variable">$cmd</span> <span class="token operator">=</span> <span class="token function">shell_exec</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'ping  '</span> <span class="token operator">.</span> <span class="token variable">$target</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>            <span class="token comment">// *nix</span></pre></td></tr><tr><td data-num="26"></td><td><pre>            <span class="token variable">$cmd</span> <span class="token operator">=</span> <span class="token function">shell_exec</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'ping  -c 4 '</span> <span class="token operator">.</span> <span class="token variable">$target</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token comment">// Feedback for the end user</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"&lt;pre><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token variable">$cmd</span><span class="token punctuation">&#125;</span></span>&lt;/pre>"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token comment">// Ops. Let the user name theres a mistake</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token keyword">echo</span> <span class="token string single-quoted-string">'&lt;pre>ERROR: You have entered an invalid IP.&lt;/pre>'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="37"></td><td><pre></pre></td></tr><tr><td data-num="38"></td><td><pre><span class="token comment">// Generate Anti-CSRF token</span></pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token function">generateSessionToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre></pre></td></tr><tr><td data-num="41"></td><td><pre><span class="token delimiter important">?></span></pre></td></tr></table></figure><p>我们用 php 复现一下</p>
<figure class="highlight php"><figcaption data-lang="PHP"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token php language-php"><span class="token delimiter important">&lt;?php</span></span></pre></td></tr><tr><td data-num="2"></td><td><pre>    </pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token variable">$ip</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'192.168.222.133 &amp;&amp; cat /etc/passwd'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token variable">$target</span> <span class="token operator">=</span> <span class="token function">stripslashes</span><span class="token punctuation">(</span><span class="token variable">$ip</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">echo</span> <span class="token variable">$target</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token variable">$octet</span> <span class="token operator">=</span> <span class="token function">explode</span><span class="token punctuation">(</span> <span class="token string double-quoted-string">"."</span><span class="token punctuation">,</span> <span class="token variable">$target</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">echo</span> <span class="token string double-quoted-string">"\n"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token variable">$i</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token variable">$i</span> <span class="token operator">&lt;</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token variable">$octet</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token variable">$i</span><span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token function">print_r</span><span class="token punctuation">(</span><span class="token variable">$octet</span><span class="token punctuation">[</span><span class="token variable">$i</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">echo</span> <span class="token string double-quoted-string">"\n"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token function">is_numeric</span><span class="token punctuation">(</span> <span class="token variable">$octet</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span> <span class="token function">is_numeric</span><span class="token punctuation">(</span> <span class="token variable">$octet</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span> <span class="token function">is_numeric</span><span class="token punctuation">(</span> <span class="token variable">$octet</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span> <span class="token function">is_numeric</span><span class="token punctuation">(</span> <span class="token variable">$octet</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span> <span class="token function">sizeof</span><span class="token punctuation">(</span> <span class="token variable">$octet</span> <span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">4</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token variable">$target</span> <span class="token operator">=</span> <span class="token variable">$octet</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'.'</span> <span class="token operator">.</span> <span class="token variable">$octet</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'.'</span> <span class="token operator">.</span> <span class="token variable">$octet</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'.'</span> <span class="token operator">.</span> <span class="token variable">$octet</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">stristr</span><span class="token punctuation">(</span> <span class="token function">php_uname</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'s'</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'Windows NT'</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token variable">$cmd</span> <span class="token operator">=</span> <span class="token function">shell_exec</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'ping  '</span> <span class="token operator">.</span> <span class="token variable">$target</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token variable">$cmd</span> <span class="token operator">=</span> <span class="token function">shell_exec</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'ping  -c 4 '</span> <span class="token operator">.</span> <span class="token variable">$target</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token keyword">echo</span> <span class="token string double-quoted-string">"&lt;pre><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token variable">$cmd</span><span class="token punctuation">&#125;</span></span>&lt;/pre>"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token keyword">echo</span> <span class="token string single-quoted-string">'&lt;pre>ERROR: You have entered an invalid IP.&lt;/pre>'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token delimiter important">?></span></pre></td></tr></table></figure><p>输出结果：</p>
<figure class="highlight txt"><figcaption data-lang="txt"></figcaption><table><tr><td data-num="1"></td><td><pre>192.168.222.133 &amp;&amp; cat /etc/passwd</pre></td></tr><tr><td data-num="2"></td><td><pre>192</pre></td></tr><tr><td data-num="3"></td><td><pre>168</pre></td></tr><tr><td data-num="4"></td><td><pre>222</pre></td></tr><tr><td data-num="5"></td><td><pre>133 &amp;&amp; cat /etc/passwd</pre></td></tr><tr><td data-num="6"></td><td><pre>&lt;pre>ERROR: You have entered an invalid IP.&lt;/pre></pre></td></tr></table></figure><p>先是过滤了反斜杠，然后将输入的 IP，按 <code>.</code>  分割，存入数组，判断数组中的元素是否为数字，有一个元素不是数字，就无法执行命令。</p>
<p>至此命令注入篇就完全结束。</p>
<h3 id="总结-2"><a class="anchor" href="#总结-2">#</a> 总结</h3>
<p>这一章学习了，命令连接符号在命令注入中的运用，并且如何防范命令注入漏洞。</p>
<ul>
<li>四种命令连接符的使用场景</li>
<li>如何防范命令注入</li>
</ul>
<h2 id="csrf"><a class="anchor" href="#csrf">#</a> CSRF</h2>
<p>CSRF，Cross-site request forgery），跨站请求伪造</p>
<p>利用受害者尚未失效的身份认证信息（cookie、会话等），诱骗其点击恶意链接或者访问包含攻击代码的页面，在受害人不知情的情况下以受害者的身份向（身份认证信息所对应的）服务器发送请求，从而完成非法操作（如转账、改密等）。</p>
<p><img loading="lazy" data-src="CRSF.png" alt="CRSF"></p>
<h3 id="low级-3"><a class="anchor" href="#low级-3">#</a> low 级</h3>
<p>先进行代码审计</p>
<figure class="highlight php"><figcaption data-lang="PHP"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token php language-php"><span class="token delimiter important">&lt;?php</span></span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token keyword">isset</span><span class="token punctuation">(</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'Change'</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token comment">// Get input</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token variable">$pass_new</span>  <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'password_new'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token variable">$pass_conf</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'password_conf'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token comment">// Do the passwords match?</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token variable">$pass_new</span> <span class="token operator">==</span> <span class="token variable">$pass_conf</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token comment">// They do!</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token variable">$pass_new</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">is_object</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">mysqli_real_escape_string</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token variable">$pass_new</span> <span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">trigger_error</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span><span class="token punctuation">,</span> <span class="token constant">E_USER_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string double-quoted-string">""</span> <span class="token punctuation">:</span> <span class="token string double-quoted-string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token variable">$pass_new</span> <span class="token operator">=</span> <span class="token function">md5</span><span class="token punctuation">(</span> <span class="token variable">$pass_new</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token comment">// Update the database</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token variable">$insert</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"UPDATE `users` SET password = '<span class="token interpolation"><span class="token variable">$pass_new</span></span>' WHERE user = '"</span> <span class="token operator">.</span> <span class="token function">dvwaCurrentUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string double-quoted-string">"';"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token function">mysqli_query</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token variable">$insert</span> <span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token keyword">die</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'&lt;pre>'</span> <span class="token operator">.</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">is_object</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">mysqli_error</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">$___mysqli_res</span> <span class="token operator">=</span> <span class="token function">mysqli_connect_error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token variable">$___mysqli_res</span> <span class="token punctuation">:</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'&lt;/pre>'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token comment">// Feedback for the user</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"&lt;pre>Password Changed.&lt;/pre>"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token comment">// Issue with passwords matching</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"&lt;pre>Passwords did not match.&lt;/pre>"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">is_null</span><span class="token punctuation">(</span><span class="token variable">$___mysqli_res</span> <span class="token operator">=</span> <span class="token function">mysqli_close</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token constant boolean">false</span> <span class="token punctuation">:</span> <span class="token variable">$___mysqli_res</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token delimiter important">?></span></pre></td></tr></table></figure><p>简单的验证了两次密码是否一致，如果一致就更新数据库，没有任何防护措施。</p>
<p>随便输入两次密码，用 BurpSuite 抓包，抓到以后，鼠标右键，选择 Engagement tools&gt;&gt;Generate CSRF PoC</p>
<p><img loading="lazy" data-src="image-20240519195354116.png" alt="image-20240519195354116"></p>
<p>自动生 CRSF 的 POC，修改 vaule，然后点击，Test in browser，复制链接到浏览器上打开，密码会被直接修改。(也可以复制到文件中打开)</p>
<p><img loading="lazy" data-src="image-20240519200013977.png" alt="image-20240519200013977"></p>
<p>在实战中常常通过构造短链接或构造文件的方式来进行攻击</p>
<p>短链接生成器：<a target="_blank" rel="noopener" href="https://my5353.com/">https://my5353.com/</a></p>
<p>将修改密码的 url： <code>http://192.168.222.132:8000/vulnerabilities/csrf/?password_new=1234&amp;password_conf=1234&amp;Change=Change</code>  粘贴上去生成短链接</p>
<p><img loading="lazy" data-src="image-20240519201031311.png" alt="image-20240519201031311"></p>
<p>直接点击短链接就可以直接修改密码</p>
<p><img loading="lazy" data-src="image-20240519202011863.png" alt="image-20240519202011863"></p>
<p>未完待续...</p>
<div class="tags"><a href="/tags/Web%E5%AE%89%E5%85%A8/" rel="tag"><i class="ic i-tag"></i>Web安全</a><a href="/tags/%E6%89%93%E9%9D%B6/" rel="tag"><i class="ic i-tag"></i>打靶</a><a href="/tags/DVWA/" rel="tag"><i class="ic i-tag"></i>DVWA</a></div></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i></span><span class="text">更新于</span><time title="修改时间：2024-06-22 15:03:24" itemprop="dateModified" datetime="2024-06-22T15:03:24+08:00">2024-06-22</time></span></div><div class="reward"><button><i class="ic i-heartbeat"></i>赞赏</button><p>请我喝[茶]~(￣▽￣)~*</p><div id="qr"><div><img loading="lazy" data-src="/assets/wechatpay.png" alt="ph0ven1x 微信支付"><p>微信支付</p></div><div><img loading="lazy" data-src="/assets/alipay.png" alt="ph0ven1x 支付宝"><p>支付宝</p></div></div></div><div id="copyright"><ul><li class="author"><strong>本文作者：</strong>ph0ven1x<i class="ic i-at"><em>@</em></i>日拱一卒 功不唐捐</li><li class="link"><strong>本文链接：</strong><a href="https://ph0ven1x.github.io/2024/05/16/DVWA%E5%85%A8%E7%BA%A7%E5%88%AB%E9%80%9A%E5%85%B3/" title="DVWA全级别通关">https://ph0ven1x.github.io/2024/05/16/DVWA全级别通关/</a></li><li class="license"><strong>版权声明：</strong>本站所有文章除特别声明外，均采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/2024/05/15/GoldenEye-v1-%E9%9D%B6%E5%9C%BA%E6%B8%97%E9%80%8F/" rel="prev" itemprop="url" data-background-image="&#x2F;2024&#x2F;05&#x2F;15&#x2F;GoldenEye-v1-%E9%9D%B6%E5%9C%BA%E6%B8%97%E9%80%8F&#x2F;goldeneye.png" title="GoldenEye v1 靶场渗透"><span class="type">上一篇</span><span class="category"><i class="ic i-flag"></i>Vulnhub靶场</span><h3>GoldenEye v1 靶场渗透</h3></a></div><div class="item right"></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#dvwa%E5%85%A8%E7%BA%A7%E5%88%AB%E9%80%9A%E5%85%B3"><span class="toc-number">1.</span> <span class="toc-text"> DVWA 全级别通关</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2"><span class="toc-number">1.1.</span> <span class="toc-text"> 安装部署</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3"><span class="toc-number">1.2.</span> <span class="toc-text"> 暴力破解</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#low%E7%BA%A7"><span class="toc-number">1.2.1.</span> <span class="toc-text"> low 级</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#medium%E7%BA%A7"><span class="toc-number">1.2.2.</span> <span class="toc-text"> medium 级</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#high%E7%BA%A7"><span class="toc-number">1.2.3.</span> <span class="toc-text"> high 级</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#impossible%E7%BA%A7"><span class="toc-number">1.2.4.</span> <span class="toc-text"> impossible 级</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">1.2.5.</span> <span class="toc-text"> 总结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5"><span class="toc-number">1.3.</span> <span class="toc-text"> 命令注入</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#low%E7%BA%A7-2"><span class="toc-number">1.3.1.</span> <span class="toc-text"> low 级</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#medium%E7%BA%A7-2"><span class="toc-number">1.3.2.</span> <span class="toc-text"> medium 级</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#high%E7%BA%A7-2"><span class="toc-number">1.3.3.</span> <span class="toc-text"> high 级</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#impossible%E7%BA%A7-2"><span class="toc-number">1.3.4.</span> <span class="toc-text"> impossible 级</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%BB%E7%BB%93-2"><span class="toc-number">1.3.5.</span> <span class="toc-text"> 总结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#csrf"><span class="toc-number">1.4.</span> <span class="toc-text"> CSRF</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#low%E7%BA%A7-3"><span class="toc-number">1.4.1.</span> <span class="toc-text"> low 级</span></a></li></ol></li></ol></li></ol></div><div class="related panel pjax" data-title="系列文章"><ul><li class="active"><a href="/2024/05/16/DVWA%E5%85%A8%E7%BA%A7%E5%88%AB%E9%80%9A%E5%85%B3/" rel="bookmark" title="DVWA全级别通关">DVWA全级别通关</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><img class="image" loading="lazy" decoding="async" itemprop="image" alt="ph0ven1x" src="/assets/avatar.jpg"><p class="name" itemprop="name">ph0ven1x</p><div class="description" itemprop="description">热爱技术，热爱生活</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">2</span><span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">4</span><span class="name">分类</span></a></div><div class="item tags"><a href="/tags/"><span class="count">5</span><span class="name">标签</span></a></div></nav><div class="social"><a target="_blank" rel="noopener" href="https://github.com/ph0ven1x" class="item github" title="https:&#x2F;&#x2F;github.com&#x2F;ph0ven1x"><i class="ic i-github"></i></a></div><div class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li></div></div></div></div><ul id="quick"><li class="prev pjax"></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/2024/05/15/GoldenEye-v1-%E9%9D%B6%E5%9C%BA%E6%B8%97%E9%80%8F/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"></div><div class="status"><div class="copyright">&copy; 2022 -<span itemprop="copyrightYear">2024</span><span class="with-love"><i class="ic i-sakura rotate"></i></span><span class="author" itemprop="copyrightHolder">ph0ven1x @ ph0ven1x</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i></span><span title="站点总字数">44k 字</span><span class="post-meta-divider"> | </span><span class="post-meta-item-icon"><i class="ic i-coffee"></i></span><span title="站点阅读时长">40 分钟</span></div><div class="powered-by">基于 <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a> & Theme.<a target="_blank" rel="noopener" href="https://github.com/theme-shoka-x/hexo-theme-shokaX/">ShokaX</a></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL = {
    ispost: true,
        path: `2024/05/16/DVWA全级别通关/`,
        favicon: {
        show: `（●´3｀●）やれやれだぜ`,
        hide: `(´Д｀)大変だ！`
    },
    search: {
        placeholder: "文章搜索",
        empty: "关于 「 ${query} 」，什么也没搜到",
        stats: "${time} ms 内找到 ${hits} 条结果"
    },
    copy_tex: false,
    katex: false,
    mermaid: false,
    audio: undefined,
    fancybox: true,
    nocopy: false,
    outime: true,
    template: `<div class="note warning"><p><span class="label warning">文章时效性提示</span><br>这是一篇发布于 {{publish}} 天前，最后一次更新在 {{updated}} 天前的文章，部分信息可能已经发生改变，请注意甄别。</p></div>`,
    quiz: {
        choice: `单选题`,
        multiple: `多选题`,
        true_false: `判断题`,
        essay: `问答题`,
        gap_fill: `填空题`,
        mistake: `错题备注`
    },
    ignores: [
        (uri) => uri.includes('#'),
        (uri) => new RegExp(LOCAL.path + '$').test(uri),
            []
    ]
};
</script><script src="https://lf9-cdn-tos.bytecdntp.com/cdn/expire-6-M/pace/1.2.4/pace.min.js" async></script><script src="/js/siteInit.js?v=0.4.2" type="module" fetchpriority="high" defer="defer"></script></body></html>